package io.github.zebalu.aoc2021;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

public class Day20 {
    public static void main(String[] args) {
        Enhancer enhancer = Enhancer.fromString(INPUT);
        firstPart(enhancer);
        secondPart(enhancer);
    }

    private static void firstPart(Enhancer enhancer) {
        System.out.println(enhancer.countLit(2));
    }

    private static void secondPart(Enhancer enhancer) {
        System.out.println(enhancer.countLit(50));
    }

    private static record Coord(int x, int y) {
        List<Coord> area() {
            return List.of(new Coord(x - 1, y - 1), new Coord(x, y - 1), new Coord(x + 1, y - 1), new Coord(x - 1, y),
                    new Coord(x, y), new Coord(x + 1, y), new Coord(x - 1, y + 1), new Coord(x, y + 1),
                    new Coord(x + 1, y + 1));
        }
    }

    private static class Image {
        static final char LIT = '#';
        static final char DARK = '.';
        int minX = 0;
        int maxX = 0;
        int minY = 0;
        int maxY = 0;
        Map<Coord, Character> map = new HashMap<>();

        void setPixel(Coord pixel, char c) {
            map.put(pixel, c);
            if (pixel.x() < minX) {
                minX = pixel.x();
            }
            if (pixel.y() < minY) {
                minY = pixel.y();
            }
            if (maxX < pixel.x()) {
                maxX = pixel.x();
            }
            if (maxY < pixel.y()) {
                maxY = pixel.y();
            }
        }

        String binaryAreaOf(Coord pixel) {
            return pixel.area().stream().map(p -> map.getOrDefault(p, DARK).charValue() == LIT ? "1" : "0")
                    .collect(Collectors.joining());
        }

        boolean contains(Coord pixel) {
            return map.containsKey(pixel);
        }

        static Image fromLines(List<String> lines) {
            Image result = new Image();
            for (int y = 0; y < lines.size(); ++y) {
                String line = lines.get(y);
                for (int x = 0; x < line.length(); ++x) {
                    result.setPixel(new Coord(x, y), line.charAt(x));
                }
            }
            return result;
        }
    }

    private static class Enhancer {
        private final String enhancerString;
        private Image image;
        Map<Memo, Character> memory = new ConcurrentHashMap<>();

        Enhancer(String enhancerString, Image image) {
            this.enhancerString = enhancerString;
            this.image = image;
        }

        boolean isLit(Coord pixel, int iteration) {
            if (iteration == 0) {
                return image.contains(pixel);
            } else {
                return Image.LIT == enhancerChar(
                        pixel.area().stream().map(p -> enhancePosition(p, iteration - 1) == Image.LIT ? "1" : "0")
                                .collect(Collectors.joining()));
            }
        }

        char enhancePosition(Coord pixel, int iteration) {
            Memo m = new Memo(pixel, iteration);
            if (memory.containsKey(m)) {
                return memory.get(m);
            } else {
                char ch;
                if (iteration == 0) {
                    ch = enhancerChar(image.binaryAreaOf(pixel));
                } else {
                    ch = enhancerChar(
                            pixel.area().stream().map(p -> enhancePosition(p, iteration - 1) == Image.LIT ? "1" : "0")
                                    .collect(Collectors.joining()));
                }
                memory.put(m, ch);
                return ch;
            }
        }

        char enhancerChar(String binary) {
            return enhancerString.charAt(Integer.parseInt(binary, 2));
        }

        long countLit(int iteration) {
            return countLit(iteration, iteration);
        }

        private long countLit(int extraSpace, int iteration) {
            return IntStream.range(image.minX - extraSpace, image.maxX + extraSpace + 1).mapToObj(Integer::valueOf)
                    .flatMap(x -> IntStream.range(image.minY - extraSpace, image.maxY + extraSpace + 1)
                            .mapToObj(y -> new Coord(x, y)))
                    .parallel().filter(c -> isLit(c, iteration - 1)).count();
        }

        static Enhancer fromString(String desc) {
            var descLines = desc.lines().toList();
            return new Enhancer(descLines.get(0), Image.fromLines(descLines.subList(2, descLines.size())));
        }
    }

    private static record Memo(Coord pixel, int iteration) {
    }

    private static final String INPUT = """
            ########.###.##.##..##..#...##..##..####.##...##..#.#.#####....#....##..##.##.##..#.##...##..#...##...#.#.####...#.###..#..#.#....####.........#.....#.....#..#.#..#..##..######..#.#.###..#...#.##....#.##.##..###.##.#..#..#####..##..##.....#.##.######..#.#...#..#.....#..#..##...##.#.###....#.#.#.#.####.##.####.##.#.#.....##..##.#...####....#..#..##.#...#..#.##.....#.#.##.###..#.#........#.#######..#..#..##.########........###.############...#...##.#######.##.########..#...#..#........#...###.#.##.#..#.####..

            ...#....##.###...##.#..#....#.###.##.....#..#...###....#.###..###.##.#.#.#.....#....#...##...#..#..#
            .#...#.#.#.####..#...#..#.#..###.##..#.####...#....###..###...#.##.#...#....#.#..##.#....#...####.#.
            #####.#.#..##..##..#.#.###.#..##.##.##.##.....#..#....#.#.##.#.##.#..#.####...#.#.##..##.####..##..#
            ...##.#...######.#..##..###...##..#.##.##.#..#####.##.#..##..#.#####.##...#.#.#..##.#.#......#..##..
            ##.#...#..#.#.#....#..#.##.###..#...#.#.....###.#...###.#....#.##..###.#..#.##..#.##.#..#....##..###
            ..#...##.#####..#.#.###....##.#.#..#.###.##.#####.##.....##...#......#..#.###.#.....###...####...#..
            .##.##.###.#.#...#..#####...#..##.#.#.##...#.##.#.#..###.#.####......#.#.##..#...#.##..#####...##..#
            ....#.#..#.......#.#.#..###.####.#.#.#.###...##..###..#.######...####..###....##.#...##.#..########.
            ...........#....###.#...##.#.##..##..##...#.#...###.#..###.#.......#........#.##..##.....#.##.#.###.
            .##.##..##...#.#.#...#.#.##.###.##..#.##.##.....######.##.....#....##....#..##.#....#..#######......
            #........####.#....#####.#..#..##...#.#.#####.#....##.#.##.##...#.#####.......#..###.#.###.####...##
            ..####..#.#....######..###.#......##...#####.####.#.#.#######..#.###...##..#..#..##.#...#.....##.###
            ####.#...####.##...#...#####...#######...#.#.##.#.##......##..###.#.#.##.#.###...#..#.###.##..##.#..
            ..#.#...#.#.....#.#.##.###..##..#.#.##..###.....#..##......###.......#.##.##...####.#...###.....#...
            ..##.######.#...#..##.###.#.#.....##......#..#......##.###.###.#.....#.#..##.###.#.#.#...#.#.###.#..
            ##.#.#.###.#.##.#..####..##..#...###.#####.###.####.#.##.#..#.##.######....#.#.#...#.#.#......##..#.
            ..###.#.##########.##...##..#.###.#...##...##..#...#..#.##.#....##.######...####....####.#...##.#..#
            ####...#.#...#.#..#.#.#.....#.#.#..##....#.....###..#....#..#.#.##.#...#..#.###.#..##.#..##.#....#..
            ##.####.#....#.##.#.#..#####.#.......#.####..#.#...###....###.#.###.#..#.###.#..####.#...#.#..#.#...
            #.###..#...###.#.#.####..#.#.##.#..###.#####..#........#..#.....##.#.#...######.#..##....###.##.##.#
            #..#.#..##.######.######.#.#.###...#....###.##..#.#.#.##.##..#.#...#..#..###....#......##...#######.
            #.####..#..##.#.###.#..##...####..#.##.#####..##.#..####..#.#..#.##..###...#..#..#.###.######.####..
            ..##..#.##...#..##....#..##...##..##..#.###.#.###....##..###.........#..#.##.#..#......#.#####.##.##
            #.##........####..#....#..#..####.######..#.######.......#.###.#.##...#.#..#.#.#.#####.#.##....#...#
            #.#.#......#.##.#.#....#.#..#.#.##...#...###..###.#.#...##...#....#.#.#..###...#.#..##.#.##.#....###
            .#....#####.#...##.#.########...###.#####.#.#....####..#.#...###.##...#..#.#....#.##..#.#.#####.#...
            .#..##.#......##.####..##..#..##....##.##.###..#..##.#...####..##...##...#..#...####..####.#.#.##.##
            .#...###..####..#.##....##.#..#...###...#.#..#.#..##.....##...#.##...#.#.######.#.##.....#.###......
            ...#.#....#..############.##...#.#...##..###..#..#.##.####.###.#.##..##.###..#..###.####..#....####.
            ....###..#.##.####..#...##.##.###...#..#.#.##.#..#.#.##..#..........#.##....#.###.#######..##.#.#.##
            ###.#.##.##.#####..#.###.#.#.#.#####.#.##...##...#.#.#############....####.###....#####.....#..##.##
            #######.#.....####.#..#.###..##...##.#..##.....#.##.....########....#..##.####.###..#..##......#..##
            ...#.#.#...####.#.###.......#...##..###...##...####.#...###..##...#..###.##.#####.####.#...#...#####
            ##.##.#.#.#.#.....##.##.##.####.#.#...###..#..#....#...#..........##.###.#..#.###.######.##..#..#...
            ##...#..####..#.##.###...#.#.##..##.#.##..##...#.#..###...#....#....###.###.#.#.#####....#.###.#.###
            .....##.#..#.######.#.#.##.###...#..#...#.....#.##.####..##..##.###.#########....#...#.#..##..###...
            .#...#######.#..#.#..#.##########...##.#.##....########..#.####.#.###.##..#..#..#.#..#.#.#######.#.#
            .#..#..#..#.##....#.....#.##.#.###.###..####..##..##..#.#.#.#.#.##..#.#..#.########.##.####...###...
            ##.#.#..#.#.#.#.#...#.###.#.####.####.#..##..#.#.#.####.#...#.###.#.######..#.#####.##..##..#..####.
            ##....#..#.####.#..#...#...########.#.#.#####.###.###..##..##.##.....#.....####.##...#.##.#....#..#.
            .##.##...###...#.##.##...###.####.#..##.#.###.####.#.....####..#.##.##..###.##.#.#.#.##..#.....#...#
            .##..####..#..###..#...##..#.........#...####.#.#######....##..#...#.....##..#.#.#..#.##.##.##..##..
            ##.###.###.##..####.#......#.#....#.####.#####....#.#.#....##.###...#.#...##.##...#####.#####..#.#..
            ####.##....##.###....#.#..##.#####.##.#.##..####...##...##.###.#..#.##...#.####.###...########......
            ###.####.##..#...###...######.###..##.#.#.#.#.#.#....#.####...#..#.....##...#.##...#.#..#.#......##.
            ...##..#....#.#...#..##....#.....##..#.#...#.###.#..#.#..#......##.##..#.##....####.#..#.###...##...
            ##..#.##...#..##....#.#.....#..#.###........###...#..######...#..###...##...####.#.#..##.###.......#
            .###...#.###...#..####.#.##.##.##...#...#..##.#....##....###..#...##..###...#....##.#...###..#.#.###
            ...#..#..#.#...##.##.##...#####.#.######..#..#...##.#...#.#....###.#.#.####..#....#..#.#..####...#..
            #...#..####.##.##....##.#.#.##.#.......###.#.##..##...#.#..##.#.####.#..##.##...#..#.###..##.......#
            ###..##.#..#.#...#.#......#.##.#.##..#..#...#....#.....#..##..#..#..###.#..#...#.#.....#.###......##
            #..##.#####.#.##.####.......#.#..#.##...#.#.#....#.#.######...##...##...####.#..#..#.###.#.#...####.
            ....#.#.##.#.##.#.##.###.#.###..#####.#.###.##..#.#..##....###...##...#.#..#.##..####.###.######.#.#
            ..###.##.....#.#.####.##.#.#.##.#####...##.#.##.###.#..##.###.#.###.........##....##.#.##....#.##...
            ##...#.#..#.#.#.###.###.#...#.#..#..#...###.###..####....####.........#..#####.##..#..##...##.##...#
            .#..#..#.##.###.#...#...#...#.##...#...##....###.......#.#####..#..###...######..##..##.##.#.#.###.#
            ..#...#.##.##.####....##.#..#.##.##.#.##.#.#...#.#.#####......###...#..#.#...#.#..###.####...##.#.#.
            .#.....##.#######..#...#.#.##.#.#...#.....##.#.......##......##.##..#.#.#.##..#.##..##.#.##..##.#..#
            ###.##..##.###.##..#.#.#.#.#.##......##..##...#.##..##.#.####..###.#...#....##.##.#.#...#.....#.##..
            ###..#...#..##.##..#.#...######...#.###..###..##.##...#..###.....#...####...#..#...#.##.#.###.......
            #...###.#...#####.#.##...#...#.....###..#..#.##.##.###....##.#..#.....#..#.##.#..####.##.....##.#..#
            #..##...##..###......#####.##.#.#..##.##.##..#.......#..#.###.#...##..#####.####.#.....#.###..###.##
            ...#.......#.#..######..####.....##.###..#####..##....#..#.#...#..##.#....###.#..........###.#.#.#..
            .###...#.##..#.#...#..##..###.##..#.#.##.#.#..#.#..########..#.#.#...#.##..#...###...##..##..##.####
            .#####....##..#.####.#..#..#.###.####....#..#...#.#.##.#..##..#.###.###...#...#....##.....##.#..###.
            .#..###.##..###......#.#.##..#########.#.###............##.##......#####.#..#..######..#....#.##.##.
            .##.......####..###..###...####..#..#####.####..##.....#.###..#.##..##.#.#....##...#..##....##.#.###
            ###.###.#..#.##....##.#..#..#..#..####.#.#.##.#.##.#.#####.#..#.#.#####.####.##.#.####.....#.#.#####
            ##..#.####..##.####.#####..##.#..###..##.##.....####.##..##..#.#..#......##.###.#..########.#.#..#..
            ####..###.#.######...####.###..#.#....##.#.#.##.#.#.#.##.#....#.####.#.#.#####.......##.#...##.##...
            ..#..##.#.##.#.....#.#.##.#.#.#####......##.##.##.####....####.#.#.###....##..#..#.#####.##...##.#.#
            ....##..#..#.#.#.##.##.#.###..#.###.....#.##.#.##.#.###.#....#.....#....#####.....#.##...#.##....###
            ###.#.##.###..###...#...#...#.....#..##...##.###.#..##..##.#.#.#######.....#..#.#.#.####.#.#...###.#
            .##.####.#.##..#.#....###..#.##.#.....##..##.##.....###..##.#...####.##.#.#######.###........#.#.###
            ......#.##.######.##...##.#..##..#.#####...###.#....###.######.#####...#.#..##..#.##....#..#....#..#
            ##...#....#..##..##.#.##.#.#...##.##.#...##.##.##..#..#...#...##..####..######..#..#.###...#..#..#..
            ....#..#...#.#.###....#..#.#.......#..#.###..#######.##.#.####.#..#.#.#..##....#..#.##...#.###.####.
            ..###..##.#...##.##....####.##..##.##.##.##...###..##.#.#....##.##...##.....##..#.###.#.##..#######.
            #.##........##....#.#..#..#..#.#.###..#.##.#.#.###...#.##...#....###..##.#.#..#.###.#..##..#.#...##.
            ##......#...#.#...###..........#...##.#..######...#.....#.#.##.###.#.#.#.##.###.#....#..#.##.##.#..#
            #..#####...#.#..###..#..##.##..##...#.##...#.###.#..#.#..##.###.####.##..##.##...##..#.##.#...#.####
            ##.###..#.....###.#.#.#..#..##.#........#####.#..#.####.#..##.##..#.##...#.#...#.#.##.##..#.###.###.
            #####.#..#.##...#.###..#####...#####..##..#..#..#####..###.####.#...#...####..##.###....##.##.###...
            ##.####.#..#..##.#..#..###...####.##..#.#..#.##.#.###.#..#.#...#..##.#.#..#######.##.#..##..###...##
            ##..##.....##..#####..#...###.##.###.####.###.##.#.########...#.#.####..###.##.#..##########.#.....#
            #.#.##...#.#...##.##..#.#.#...#.#.##.#.###.#...##...##.....###.#..#.#..####.#..#.#######.##.#.##.##.
            ##.#..####.#.....#.#..##.##...###...#..#.##.##..###.#####.##....#.#..#...#####...#.##..#.#..#....#..
            ##.###.##.#...#.##.....##..###..#.#..###..##.###.....#...#...#.##.#....#..#...####.#..#..#.#.#.#.###
            .####......###.#........#..#..#....###.#.#.....#..#...###.####.#...###.#..###.#.#...###...###..#####
            ##.#.###.#.#.#..##.##.###.######...#.#.##..#...##..#...##.#.##..#.#..#.##.#.#.##.##.#..####...#.#...
            ##.......#.##...#.#.....##..#.#..#...#..#..#..#..#.#.###.##.#.#.#########.#.####...##......######.##
            ....##.#.##.##.#.#.#.#.##..####....#..###.#..#.##...####.....##.#.....#####.##.......##.##.#..###.#.
            .#####..##...###.##.#.....#......#..#.#..#.#..#......##..##.##..#..##.....#...##.#....#..##..#..##.#
            #.###..##...###....#.###.#.#.##..#....##...#..#.######....##.#....##...####.###.#####..##......#...#
            ##..#.#...#####..##.#.###..##..#.#.####..#..#.##.#.#.#..#.##..#.###.#####.##..#...#..#.###..#.##...#
            #.#...#######..#.####...##.#.#######..####..#.###...####.####..#...#.#....#..#.##...#.##.#..####.#.#
            #...#.##......######.#.####..####.#.#..#.#..#####...##..#.##.###.#..#.####.###.##..#..####..####....
            ###.###..#.......###..#..#.##...##.###..#...###.#....#...###.#.#.#.#...#....#.##..##.########.##....
            .#.....##.....#.#.####......#.#.#..#######.#....#.....###...###.##...#..#..##.###.#...#..###.#.#####
            ##..#..###.##...#...#...####..###...###.#.#..###.#####...#####..#####..#.#.####.##.#....#.####..####""";
}
