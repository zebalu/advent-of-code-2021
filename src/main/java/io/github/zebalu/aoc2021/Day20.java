package io.github.zebalu.aoc2021;

import java.util.Comparator;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

public class Day20 {
    public static void main(String[] args) {
        Enhancer enhancer = Enhancer.fromString(INPUT);
        firstPart(enhancer);
        secondPart(enhancer);
    }

    private static void firstPart(Enhancer enhancer) {
        System.out.println(enhancer.enhance().enhance().countLit());
    }

    private static void secondPart(Enhancer enhancer) {
        var current = enhancer;
        for(int i =0; i<50; ++i ) {
            current = current.enhance();
        }
        System.out.println(current.countLit());
    }

    private static record Coord(int x, int y) implements Comparable<Coord> {
        private static final Comparator<Coord> COORD_COMPARATOR = Comparator.comparingInt(Coord::x).thenComparingInt(Coord::y);
        List<Coord> area() {
            return List.of(new Coord(x - 1, y - 1), new Coord(x, y - 1), new Coord(x + 1, y - 1), new Coord(x - 1, y),
                    new Coord(x, y), new Coord(x + 1, y), new Coord(x - 1, y + 1), new Coord(x, y + 1),
                    new Coord(x + 1, y + 1));
        }
        @Override
        public int compareTo(Coord o) {
            return COORD_COMPARATOR.compare(this, o);
        }
    }

    private static class Image {
        static final char LIT = '#';
        static final char DARK = '.';
        final char defaultChar;
        int minX = 0;
        int maxX = 0;
        int minY = 0;
        int maxY = 0;
        Map<Coord, Character> map = new ConcurrentHashMap<>();

        Image(char defaultChar) {
            this.defaultChar = defaultChar;
        }
        
        void setPixel(Coord pixel, char c) {
            map.put(pixel, c);
            if (pixel.x() < minX) {
                minX = pixel.x();
            }
            if (pixel.y() < minY) {
                minY = pixel.y();
            }
            if (maxX < pixel.x()) {
                maxX = pixel.x();
            }
            if (maxY < pixel.y()) {
                maxY = pixel.y();
            }
        }
        
        char getPixel(Coord pixel) {
            return map.getOrDefault(pixel, defaultChar);
        }
        
        static Image fromLines(List<String> lines) {
            Image result = new Image('.');
            for (int y = 0; y < lines.size(); ++y) {
                String line = lines.get(y);
                for (int x = 0; x < line.length(); ++x) {
                    result.setPixel(new Coord(x, y), line.charAt(x));
                }
            }
            return result;
        }
    }

    private static class Enhancer {
        private final String enhancerString;
        private Image image;

        Enhancer(String enhancerString, Image image) {
            this.enhancerString = enhancerString;
            this.image = image;
        }
        
        Enhancer enhance() {
            Image result = new Image(image.defaultChar==Image.LIT?Image.DARK:Image.LIT);
            IntStream.rangeClosed(image.minX-1, image.maxX+1).mapToObj(Integer::valueOf).flatMap(x->IntStream.rangeClosed(image.minY-1, image.maxY+1).mapToObj(y->new Coord(x,y))).parallel().forEach(coord-> {
                String s = coord.area().stream().map(c->image.getPixel(c)==Image.DARK?"0":"1").collect(Collectors.joining());
                char c = enhancerString.charAt(Integer.parseInt(s, 2));
                result.setPixel(coord, c);
            });
            return new Enhancer(enhancerString, result);
        }
        
        long countLit() {
            return image.map.values().stream().filter(c->c==Image.LIT).count();
        }

        static Enhancer fromString(String desc) {
            var descLines = desc.lines().toList();
            return new Enhancer(descLines.get(0), Image.fromLines(descLines.subList(2, descLines.size())));
        }
    }

    private static final String INPUT = """
            ########.###.##.##..##..#...##..##..####.##...##..#.#.#####....#....##..##.##.##..#.##...##..#...##...#.#.####...#.###..#..#.#....####.........#.....#.....#..#.#..#..##..######..#.#.###..#...#.##....#.##.##..###.##.#..#..#####..##..##.....#.##.######..#.#...#..#.....#..#..##...##.#.###....#.#.#.#.####.##.####.##.#.#.....##..##.#...####....#..#..##.#...#..#.##.....#.#.##.###..#.#........#.#######..#..#..##.########........###.############...#...##.#######.##.########..#...#..#........#...###.#.##.#..#.####..

            ...#....##.###...##.#..#....#.###.##.....#..#...###....#.###..###.##.#.#.#.....#....#...##...#..#..#
            .#...#.#.#.####..#...#..#.#..###.##..#.####...#....###..###...#.##.#...#....#.#..##.#....#...####.#.
            #####.#.#..##..##..#.#.###.#..##.##.##.##.....#..#....#.#.##.#.##.#..#.####...#.#.##..##.####..##..#
            ...##.#...######.#..##..###...##..#.##.##.#..#####.##.#..##..#.#####.##...#.#.#..##.#.#......#..##..
            ##.#...#..#.#.#....#..#.##.###..#...#.#.....###.#...###.#....#.##..###.#..#.##..#.##.#..#....##..###
            ..#...##.#####..#.#.###....##.#.#..#.###.##.#####.##.....##...#......#..#.###.#.....###...####...#..
            .##.##.###.#.#...#..#####...#..##.#.#.##...#.##.#.#..###.#.####......#.#.##..#...#.##..#####...##..#
            ....#.#..#.......#.#.#..###.####.#.#.#.###...##..###..#.######...####..###....##.#...##.#..########.
            ...........#....###.#...##.#.##..##..##...#.#...###.#..###.#.......#........#.##..##.....#.##.#.###.
            .##.##..##...#.#.#...#.#.##.###.##..#.##.##.....######.##.....#....##....#..##.#....#..#######......
            #........####.#....#####.#..#..##...#.#.#####.#....##.#.##.##...#.#####.......#..###.#.###.####...##
            ..####..#.#....######..###.#......##...#####.####.#.#.#######..#.###...##..#..#..##.#...#.....##.###
            ####.#...####.##...#...#####...#######...#.#.##.#.##......##..###.#.#.##.#.###...#..#.###.##..##.#..
            ..#.#...#.#.....#.#.##.###..##..#.#.##..###.....#..##......###.......#.##.##...####.#...###.....#...
            ..##.######.#...#..##.###.#.#.....##......#..#......##.###.###.#.....#.#..##.###.#.#.#...#.#.###.#..
            ##.#.#.###.#.##.#..####..##..#...###.#####.###.####.#.##.#..#.##.######....#.#.#...#.#.#......##..#.
            ..###.#.##########.##...##..#.###.#...##...##..#...#..#.##.#....##.######...####....####.#...##.#..#
            ####...#.#...#.#..#.#.#.....#.#.#..##....#.....###..#....#..#.#.##.#...#..#.###.#..##.#..##.#....#..
            ##.####.#....#.##.#.#..#####.#.......#.####..#.#...###....###.#.###.#..#.###.#..####.#...#.#..#.#...
            #.###..#...###.#.#.####..#.#.##.#..###.#####..#........#..#.....##.#.#...######.#..##....###.##.##.#
            #..#.#..##.######.######.#.#.###...#....###.##..#.#.#.##.##..#.#...#..#..###....#......##...#######.
            #.####..#..##.#.###.#..##...####..#.##.#####..##.#..####..#.#..#.##..###...#..#..#.###.######.####..
            ..##..#.##...#..##....#..##...##..##..#.###.#.###....##..###.........#..#.##.#..#......#.#####.##.##
            #.##........####..#....#..#..####.######..#.######.......#.###.#.##...#.#..#.#.#.#####.#.##....#...#
            #.#.#......#.##.#.#....#.#..#.#.##...#...###..###.#.#...##...#....#.#.#..###...#.#..##.#.##.#....###
            .#....#####.#...##.#.########...###.#####.#.#....####..#.#...###.##...#..#.#....#.##..#.#.#####.#...
            .#..##.#......##.####..##..#..##....##.##.###..#..##.#...####..##...##...#..#...####..####.#.#.##.##
            .#...###..####..#.##....##.#..#...###...#.#..#.#..##.....##...#.##...#.#.######.#.##.....#.###......
            ...#.#....#..############.##...#.#...##..###..#..#.##.####.###.#.##..##.###..#..###.####..#....####.
            ....###..#.##.####..#...##.##.###...#..#.#.##.#..#.#.##..#..........#.##....#.###.#######..##.#.#.##
            ###.#.##.##.#####..#.###.#.#.#.#####.#.##...##...#.#.#############....####.###....#####.....#..##.##
            #######.#.....####.#..#.###..##...##.#..##.....#.##.....########....#..##.####.###..#..##......#..##
            ...#.#.#...####.#.###.......#...##..###...##...####.#...###..##...#..###.##.#####.####.#...#...#####
            ##.##.#.#.#.#.....##.##.##.####.#.#...###..#..#....#...#..........##.###.#..#.###.######.##..#..#...
            ##...#..####..#.##.###...#.#.##..##.#.##..##...#.#..###...#....#....###.###.#.#.#####....#.###.#.###
            .....##.#..#.######.#.#.##.###...#..#...#.....#.##.####..##..##.###.#########....#...#.#..##..###...
            .#...#######.#..#.#..#.##########...##.#.##....########..#.####.#.###.##..#..#..#.#..#.#.#######.#.#
            .#..#..#..#.##....#.....#.##.#.###.###..####..##..##..#.#.#.#.#.##..#.#..#.########.##.####...###...
            ##.#.#..#.#.#.#.#...#.###.#.####.####.#..##..#.#.#.####.#...#.###.#.######..#.#####.##..##..#..####.
            ##....#..#.####.#..#...#...########.#.#.#####.###.###..##..##.##.....#.....####.##...#.##.#....#..#.
            .##.##...###...#.##.##...###.####.#..##.#.###.####.#.....####..#.##.##..###.##.#.#.#.##..#.....#...#
            .##..####..#..###..#...##..#.........#...####.#.#######....##..#...#.....##..#.#.#..#.##.##.##..##..
            ##.###.###.##..####.#......#.#....#.####.#####....#.#.#....##.###...#.#...##.##...#####.#####..#.#..
            ####.##....##.###....#.#..##.#####.##.#.##..####...##...##.###.#..#.##...#.####.###...########......
            ###.####.##..#...###...######.###..##.#.#.#.#.#.#....#.####...#..#.....##...#.##...#.#..#.#......##.
            ...##..#....#.#...#..##....#.....##..#.#...#.###.#..#.#..#......##.##..#.##....####.#..#.###...##...
            ##..#.##...#..##....#.#.....#..#.###........###...#..######...#..###...##...####.#.#..##.###.......#
            .###...#.###...#..####.#.##.##.##...#...#..##.#....##....###..#...##..###...#....##.#...###..#.#.###
            ...#..#..#.#...##.##.##...#####.#.######..#..#...##.#...#.#....###.#.#.####..#....#..#.#..####...#..
            #...#..####.##.##....##.#.#.##.#.......###.#.##..##...#.#..##.#.####.#..##.##...#..#.###..##.......#
            ###..##.#..#.#...#.#......#.##.#.##..#..#...#....#.....#..##..#..#..###.#..#...#.#.....#.###......##
            #..##.#####.#.##.####.......#.#..#.##...#.#.#....#.#.######...##...##...####.#..#..#.###.#.#...####.
            ....#.#.##.#.##.#.##.###.#.###..#####.#.###.##..#.#..##....###...##...#.#..#.##..####.###.######.#.#
            ..###.##.....#.#.####.##.#.#.##.#####...##.#.##.###.#..##.###.#.###.........##....##.#.##....#.##...
            ##...#.#..#.#.#.###.###.#...#.#..#..#...###.###..####....####.........#..#####.##..#..##...##.##...#
            .#..#..#.##.###.#...#...#...#.##...#...##....###.......#.#####..#..###...######..##..##.##.#.#.###.#
            ..#...#.##.##.####....##.#..#.##.##.#.##.#.#...#.#.#####......###...#..#.#...#.#..###.####...##.#.#.
            .#.....##.#######..#...#.#.##.#.#...#.....##.#.......##......##.##..#.#.#.##..#.##..##.#.##..##.#..#
            ###.##..##.###.##..#.#.#.#.#.##......##..##...#.##..##.#.####..###.#...#....##.##.#.#...#.....#.##..
            ###..#...#..##.##..#.#...######...#.###..###..##.##...#..###.....#...####...#..#...#.##.#.###.......
            #...###.#...#####.#.##...#...#.....###..#..#.##.##.###....##.#..#.....#..#.##.#..####.##.....##.#..#
            #..##...##..###......#####.##.#.#..##.##.##..#.......#..#.###.#...##..#####.####.#.....#.###..###.##
            ...#.......#.#..######..####.....##.###..#####..##....#..#.#...#..##.#....###.#..........###.#.#.#..
            .###...#.##..#.#...#..##..###.##..#.#.##.#.#..#.#..########..#.#.#...#.##..#...###...##..##..##.####
            .#####....##..#.####.#..#..#.###.####....#..#...#.#.##.#..##..#.###.###...#...#....##.....##.#..###.
            .#..###.##..###......#.#.##..#########.#.###............##.##......#####.#..#..######..#....#.##.##.
            .##.......####..###..###...####..#..#####.####..##.....#.###..#.##..##.#.#....##...#..##....##.#.###
            ###.###.#..#.##....##.#..#..#..#..####.#.#.##.#.##.#.#####.#..#.#.#####.####.##.#.####.....#.#.#####
            ##..#.####..##.####.#####..##.#..###..##.##.....####.##..##..#.#..#......##.###.#..########.#.#..#..
            ####..###.#.######...####.###..#.#....##.#.#.##.#.#.#.##.#....#.####.#.#.#####.......##.#...##.##...
            ..#..##.#.##.#.....#.#.##.#.#.#####......##.##.##.####....####.#.#.###....##..#..#.#####.##...##.#.#
            ....##..#..#.#.#.##.##.#.###..#.###.....#.##.#.##.#.###.#....#.....#....#####.....#.##...#.##....###
            ###.#.##.###..###...#...#...#.....#..##...##.###.#..##..##.#.#.#######.....#..#.#.#.####.#.#...###.#
            .##.####.#.##..#.#....###..#.##.#.....##..##.##.....###..##.#...####.##.#.#######.###........#.#.###
            ......#.##.######.##...##.#..##..#.#####...###.#....###.######.#####...#.#..##..#.##....#..#....#..#
            ##...#....#..##..##.#.##.#.#...##.##.#...##.##.##..#..#...#...##..####..######..#..#.###...#..#..#..
            ....#..#...#.#.###....#..#.#.......#..#.###..#######.##.#.####.#..#.#.#..##....#..#.##...#.###.####.
            ..###..##.#...##.##....####.##..##.##.##.##...###..##.#.#....##.##...##.....##..#.###.#.##..#######.
            #.##........##....#.#..#..#..#.#.###..#.##.#.#.###...#.##...#....###..##.#.#..#.###.#..##..#.#...##.
            ##......#...#.#...###..........#...##.#..######...#.....#.#.##.###.#.#.#.##.###.#....#..#.##.##.#..#
            #..#####...#.#..###..#..##.##..##...#.##...#.###.#..#.#..##.###.####.##..##.##...##..#.##.#...#.####
            ##.###..#.....###.#.#.#..#..##.#........#####.#..#.####.#..##.##..#.##...#.#...#.#.##.##..#.###.###.
            #####.#..#.##...#.###..#####...#####..##..#..#..#####..###.####.#...#...####..##.###....##.##.###...
            ##.####.#..#..##.#..#..###...####.##..#.#..#.##.#.###.#..#.#...#..##.#.#..#######.##.#..##..###...##
            ##..##.....##..#####..#...###.##.###.####.###.##.#.########...#.#.####..###.##.#..##########.#.....#
            #.#.##...#.#...##.##..#.#.#...#.#.##.#.###.#...##...##.....###.#..#.#..####.#..#.#######.##.#.##.##.
            ##.#..####.#.....#.#..##.##...###...#..#.##.##..###.#####.##....#.#..#...#####...#.##..#.#..#....#..
            ##.###.##.#...#.##.....##..###..#.#..###..##.###.....#...#...#.##.#....#..#...####.#..#..#.#.#.#.###
            .####......###.#........#..#..#....###.#.#.....#..#...###.####.#...###.#..###.#.#...###...###..#####
            ##.#.###.#.#.#..##.##.###.######...#.#.##..#...##..#...##.#.##..#.#..#.##.#.#.##.##.#..####...#.#...
            ##.......#.##...#.#.....##..#.#..#...#..#..#..#..#.#.###.##.#.#.#########.#.####...##......######.##
            ....##.#.##.##.#.#.#.#.##..####....#..###.#..#.##...####.....##.#.....#####.##.......##.##.#..###.#.
            .#####..##...###.##.#.....#......#..#.#..#.#..#......##..##.##..#..##.....#...##.#....#..##..#..##.#
            #.###..##...###....#.###.#.#.##..#....##...#..#.######....##.#....##...####.###.#####..##......#...#
            ##..#.#...#####..##.#.###..##..#.#.####..#..#.##.#.#.#..#.##..#.###.#####.##..#...#..#.###..#.##...#
            #.#...#######..#.####...##.#.#######..####..#.###...####.####..#...#.#....#..#.##...#.##.#..####.#.#
            #...#.##......######.#.####..####.#.#..#.#..#####...##..#.##.###.#..#.####.###.##..#..####..####....
            ###.###..#.......###..#..#.##...##.###..#...###.#....#...###.#.#.#.#...#....#.##..##.########.##....
            .#.....##.....#.#.####......#.#.#..#######.#....#.....###...###.##...#..#..##.###.#...#..###.#.#####
            ##..#..###.##...#...#...####..###...###.#.#..###.#####...#####..#####..#.#.####.##.#....#.####..####""";
}
